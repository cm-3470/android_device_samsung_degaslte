From 681b0ae4231b4753bbe189e816beb8eb677ca914 Mon Sep 17 00:00:00 2001
From: tobigun <hennymcc@yahoo.de>
Date: Sun, 10 Jan 2016 19:45:58 +0100
Subject: [PATCH] RIL: avoid crash after calls

Change-Id: I99971f28a2289260a6f83ddc5500e396bebe3de4
---
 include/telephony/ril.h |  1 +
 libril/ril.cpp          | 18 ++++++++++++++++++
 rild/rild.c             |  9 +++++++--
 3 files changed, 26 insertions(+), 2 deletions(-)
 mode change 100644 => 100755 libril/ril.cpp

diff --git a/include/telephony/ril.h b/include/telephony/ril.h
index 834fead..eb0dd48 100644
--- a/include/telephony/ril.h
+++ b/include/telephony/ril.h
@@ -5068,6 +5068,7 @@ typedef struct {
 
 /***********************************************************************/
 
+#define RIL_UNSOL_AM 11010
 
 #if defined(ANDROID_MULTI_SIM)
 /**
diff --git a/libril/ril.cpp b/libril/ril.cpp
old mode 100644
new mode 100755
index eda2d75..dcce97b
--- a/libril/ril.cpp
+++ b/libril/ril.cpp
@@ -169,6 +169,8 @@ static pthread_t s_tid_dispatch;
 static pthread_t s_tid_reader;
 static int s_started = 0;
 
+static int s_cpCrashed = 0;
+
 static int s_fdDebug = -1;
 static int s_fdDebug_socket2 = -1;
 
@@ -4876,6 +4878,14 @@ void RIL_onUnsolicitedResponse(int unsolResponse, const void *data,
                                             &TIMEVAL_WAKE_TIMEOUT);
     }
 
+    if (unsolResponse == RIL_UNSOL_AM) {
+        // "start -a android.intent.action.MAIN -n com.sec.app.RilErrorNotifier/.PhoneCrashNotifier --es title cpcrash"
+        if (strstr((const char*)data, "cpcrash")) {
+            RLOGE("CP crash detected");
+            s_cpCrashed = 1;
+        }
+    }
+
     // Normal exit
     return;
 
@@ -4885,6 +4895,14 @@ error_exit:
     }
 }
 
+extern "C"
+int RIL_getCpCrashed()
+{
+    int result = s_cpCrashed;
+    s_cpCrashed = 0;
+    return result;
+}
+
 /** FIXME generalize this if you track UserCAllbackInfo, clear it
     when the callback occurs
 */
diff --git a/rild/rild.c b/rild/rild.c
index efc7c9d..3b9d9b1 100644
--- a/rild/rild.c
+++ b/rild/rild.c
@@ -68,6 +68,8 @@ extern void RIL_onUnsolicitedResponse(int unsolResponse, const void *data,
         size_t datalen);
 #endif
 
+extern int RIL_getCpCrashed();
+
 extern void RIL_requestTimedCallback (RIL_TimedCallback callback,
         void *param, const struct timeval *relativeTime);
 
@@ -368,7 +370,10 @@ OpenLib:
 done:
 
     RLOGD("RIL_Init starting sleep loop");
-    while (true) {
-        sleep(UINT32_MAX);
+    while (!RIL_getCpCrashed()) {
+        sleep(1);
     }
+
+    RLOGD("CP crashed -> restart");
+    return 1;
 }
-- 
1.9.1

